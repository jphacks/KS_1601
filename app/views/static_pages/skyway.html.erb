<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>demo</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://skyway.io/dist/0.3/peer.js"></script>
    </head>

    <body>
        <div id="myId"></div>
        <div id="peerId"></div>
        <input type="text" id="peerId_input"><button id="connect">connect</button>
        <button id="close">close</button>
        <div id="talk"></div>
        <input type="text" id="message"><button id="send">send</button><br>
        <form name="file_send">
            <input type="file" id="send_file"><br>
        </form>
        <textarea id="file_result" style="width:100%; height:200px; margin:0px 0px 5px 0px;" disabled></textarea>


        <script>
        $(document).ready(function () {
            var APIKEY = '618a0ac8-3049-4460-8002-baf376413ea3';
            var myPeerId = '';
            var room = '';
            //自分のIDの申請
            var peer = new Peer({key: APIKEY, debug: 3});

            peer.on('error', function(err){
                 console.error(err);
            });

            //自分のID取得まで
            peer.on('open', function(id) {
                myPeerId = id;
                $("#myId").append("<h5>My ID : " + id + "<h5>");
             });

            //相手からチャット開始の宣言が来た場合
            peer.on('connection', function(dataConnection) {
                room = dataConnection;
                console.log("hogehoge");
                room.on("open",function(){
                    $("#peerId").append("<h5>Peer ID : " + room.id + "<h5>");
                });
                room.on("data",function(data){
                    if(data === "1"){
                        room.on("data",function(data){
                            $("#talk").append("<h6>" + room.id + " : " + data + "<h5>");
                        });
                    }else if(data === "2"){
                        room.on("data",function(data){
                            $("#file_result").append(data);
                        });
                    }
                });
            });

            //自分からチャット開始の宣言をする場合
            $("#connect").click(function(){
                // 接続先のIDをフォームから取得する
                var peerId = $('#peerId_input').val();
                // 相手への接続を開始する
                room = peer.connect(peerId);
                room.on("open",function(){
                    $("#peerId").append("<h5>Peer ID : " + room.id + "<h5>");
                });
                room.on("data",function(data){
                    if(data === "1"){
                        room.on("data",function(data){
                            $("#talk").append("<h6>" + room.id + " : " + data + "<h5>");
                        });
                    }else if(data === "2"){
                        room.on("data",function(data){
                            $("#file_result").append(data);
                        });
                    }
                });
            });

            // Sendボタンクリック時の動作
            $("#send").click(function() {
                //flag
                room.send("1");
                // 送信テキストの取得
                var message = $("#message").val();
                // 送信
                // faleとの区別に最初にflagとして決まった文字を返信するのもひとつの手
                room.send(message);
                // 自分の画面に表示
                $("#talk").append("<h6>" + myPeerId + " : " + message + "<h5>");
                // 送信テキストボックスをクリア
                $("#message").val("");
            });

            // ファイル読み込み
            //　通常のメッセージ送信と区別するためにはflagとして決まった文字を返信するのもひとつの手
            var obj = document.getElementById("send_file");
            obj.addEventListener("change",function(evt){
                // flag
                room.send("2");
                // file 読み込み
                var file_list = obj.files;
                var reader = new FileReader();
                reader.readAsText(file_list[0]);
                reader.onload = function(ev){
                    room.send(reader.result);
                    $("#file_result").append(reader.result);
                }
            },false);


            // Closeボタンクリック時の動作
            $("#close").click(function() {
                room.close();
            });
        });
        </script>
    </body>
</html>
